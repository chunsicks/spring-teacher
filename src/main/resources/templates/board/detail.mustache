{{>layout/header}}

<div class="container p-5">

    <!-- ìˆ˜ì •ì‚­ì œë²„íŠ¼ -->
    {{#model.isOwner}}
        <div class="d-flex justify-content-end">
            <a href="/api/board/{{model.id}}/update-form" class="btn btn-warning me-1">ìˆ˜ì •</a>
            <form action="/api/board/{{model.id}}/delete" method="post">
                <button class="btn btn-danger">ì‚­ì œ</button>
            </form>
        </div>
    {{/model.isOwner}}

    <div class="d-flex justify-content-end">
        <b>ì‘ì„±ì</b> : {{model.username}}
    </div>

    <!-- ê²Œì‹œê¸€ë‚´ìš© -->
    <div>
        <h2><b>{{model.title}}</b></h2>
        <hr/>
        <div class="m-4 p-2">
            {{{model.content}}}
        </div>
    </div>
    <!-- ëŒ“ê¸€ -->
    <div class="card mt-3">
        <!-- ëŒ“ê¸€ë“±ë¡ -->
        <div class="card-body">
            <form>
                <input type="hidden" value="{{model.id}}" id="boardId">
                <textarea class="form-control" rows="2" id="comment"></textarea>
                <div class="d-flex justify-content-end">
                    <button onclick="saveReply()" type="button" class="btn btn-outline-primary mt-1">ëŒ“ê¸€ë“±ë¡</button>
                </div>
            </form>
        </div>
        <!-- ëŒ“ê¸€ëª©ë¡ -->
        <div class="card-footer">
            <b>ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸</b>
        </div>
        <div class="list-group" id="reply-box">
            {{#model.replies}}
                <!-- ëŒ“ê¸€ì•„ì´í…œ -->
                <div id="reply-{{id}}" class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <div class="px-1 me-1 bg-primary text-white rounded">{{username}}</div>
                        <div>{{comment}}</div>
                    </div>
                    {{#isOwner}}
                        <form>
                            <button onclick="deleteReply('{{id}}')" type="button" class="btn">ğŸ—‘</button>
                        </form>
                    {{/isOwner}}
                </div>
            {{/model.replies}}
        </div>
    </div>
</div>
<script>
    //ë¦¬ë¡œë“œ ì•ˆ í•˜ë ¤ê³ 
    // ë””ìì¸ì— ë°ì´í„° ë°”ì¸ë”©í•˜ëŠ”ê²ƒ  ë¨¸ìŠ¤í…Œì¹˜ì™€ ë¹„ìŠ·í•˜ë‹¤
    // ì˜ˆì „ì—ëŠ” ìë°” ë°ì´í„° ë°”ì¸ë”©í–ˆì§€
    // ì±…ì„ -> ë””ìì¸ì— ë°ì´í„° ë°”ì¸ë”©
    //ìˆ˜ì •í•  ë•Œë„ ì¬ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤
    function replyItem(reply) {
        return ` <div id="reply-${reply.id}" class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex">
                        <div class="px-1 me-1 bg-primary text-white rounded">${reply.username}</div>
                        <div>${reply.comment}</div>
                    </div>
                        <form>
                            <button onclick="deleteReply('${reply.id}')" type="button" class="btn">ğŸ—‘</button>
                        </form>
                </div>`;
    }
    //ì–´íŒ¬ë“œ? í”„ë¦¬íŒ¬ë“œ???  ì°¾ì•„ë³´ì

    //1. ì±…ì„ -> í†µì‹ í•´ì„œ ë°ì´í„° ìš”ì²­í•˜ê³  ì‘ë‹µë°›ìœ¼ë©´ CSRí•˜ê¸°!  ë©”ì„œë“œ ë§Œë“¤ ë•Œ ì–´ë–¤ ì±…ì„ì„ ê°€ì¡ŒëŠ”ì§€ ìƒê°í•˜ê³  ë§Œë“¤ê¸°!
    async function saveReply() {
        //1. Reply ê°ì²´ ë§Œë“¤ê¸°(IDë¡œ ì°¾ì•„ì„œ)
        //ì´ê±° ê·¸ëŒ€ë¡œ ì „ì†¡ ëª»í•´ì„œ jsonìœ¼ë¡œ ë³€ê²½í•´ì„œ ë³´ë‚´ì•¼í•¨
        let reply = {
            comment: $("#comment").val(),
            boardId: $("#boardId").val()
        };

        //2. fetch ìš”ì²­í•˜ê¸°  ë©”ì„œë“œ, ì–´ë–¤ ë§ˆì„íƒ€ì…ê°€ì§€ê³  ìˆëŠ”ì§€(ì»¨íƒ íŠ¸ íƒ€ì…)   getì€ whereì ˆì— ê±¸ë ¤ê³  ì“°ë‹ˆê¹Œ ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì´ë‹¤
        let response = await fetch(`/api/reply`, {
            method: "post",
            body: JSON.stringify(reply),
            headers: {
                "Content-Type": "application/json; charset=utf-8"
            }
        });
        //íŒŒì‹±
        let responseBody = await response.json(); // DTO!!
        console.log(responseBody);

        //3.CSR í•˜ê¸°
        //ì´ê±°ëŠ” ì „ì²´ ë¦¬ë¡œë“œ
        //location.reload();
        //ì™œ ë°”ë””ì¸ê°€? ë¦¬ìŠ¤í€ìŠ¤ ë°”ë”” . ë°”ë””ì— ë“¤ì–´ê°€ ìˆê¸° ë•Œë¬¸ì—!!
        $("#reply-box").prepend(replyItem(responseBody.body));
        //ê³µë°± ë„£ìœ¼ë ¤ê³ 
        $("textarea").val("");
    }
    //ì‚­ì œ ì±…ì„ -> í†µì‹ í•´ì„œ ë°ì´í„° ìš”ì²­í•˜ê³  ì‘ë‹µë°›ìœ¼ë©´ CSRí•˜ê¸°!
    async function deleteReply(id) {
        //1. header + body
        let response = await fetch(`/api/reply/${id}`, {
            method: "delete"
        });
        // console.log(response);

        //2. body(parsing)
        let responseBody = await response.json();//íŒŒì‹±
        //  console.log(responseBody);
        if (response.ok) {
            $(`#reply-${id}`).remove();
            //location.reload();  f5 ë•Œë¦¬ëŠ”ê±°
            /*
            f5ë•Œë¦¬ë©´ fetch ì•ˆë³´ì„ ìƒˆë¡œê³ ì¹¨ ì „ì˜ ê²ƒì´ê¸°ì— ì´ëŸ´êº¼ë©´ formì“°ì§€
            ì¦‰ ë‹¤ì‹œ ë‹¤ ë‹¤ìš´ë°›ëŠ” ê±°ì„   ë‹¤ì‹œ ë‹¤ ë‹¤ìš´ë°›ëŠ”ê²Œ ì•„ë‹Œ ìºì‹±í•˜ëŠ”ê²Œ ë§ë‹¤! css js ì´ëŸ°ê²ƒ ì •ì ëŒ€ì´í„°ëŠ” ë³€í•˜ì§€ ì•ŠëŠ”ë‹¤.
            ë‚´ê°€ ìºì‹±í•˜ê³ ìˆëŠ”ê±´ê°€? ê³µë¶€í•´ì•¼í•œë‹¤!

            ë‚˜ì¤‘ì— ì´ëŸ° ë°ì´í„°ë“¤ì€ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëƒë©´ ìŠ¤í”„ë§ ì„œë²„
             */
        } else {
            alert(responseBody.msg);
        }
    }
</script>

{{>layout/footer}}